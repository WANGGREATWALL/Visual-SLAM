# 第2讲 初识SLAM

`王琛` | `2020/10/02`

[toc]

> **主要目标:** 本讲概括地介绍一个视觉 SLAM 系统的结构, 作为后续内容的大纲. 实践部分介绍环境搭建、程序基本知识, 最后完成一个 "Hello SLAM" 程序.
>
> 1. 理解一个视觉 SLAM 框架由哪几个模块组成, 各模块的任务是什么?
> 2. 搭建编程环境, 为开发和实验做准备;
> 3. 理解如何在 Linux 下编译并运行一个程序, 如果程序出了问题, 又该如何对它进行调试;
> 4. 掌握 cmake 的基本使用方法;

## 2.1 经典视觉SLAM框架

SLAM 需要一个完善的算法框架, 而经过研究者们长期的努力工作, 现有这个框架已经定型了.

![image-20201002173359361](https://i.loli.net/2020/10/03/7uov1EpH4TRChZ9.png)

视觉 SLAM 流程包括以下步骤:

1. 传感器信息读取. 在视觉 SLAM 中主要为相机图像信息的读取和预处理. 如果是在机器人中, 还可能有码盘、惯性传感器等信息的读取和同步;
2. **视觉里程计** (Visual Odometry, VO). 视觉里程计的任务是估算相邻图像间相机的运动, 以及局部地图的样子. VO 又称为前端 (Front End);
3. **后端优化** (Optimization). 后端接受不同时刻视觉里程计测量的相机位姿, 以及回环检测的信息, 对它们进行优化, 得到全局一致的轨迹和地图. 由于接在 VO 之后, 又称为后端 (Back End);
4. **回环检测** (Loop Closing). 回环检测判断机器人是否到达过先前的位置. 如果检测到回环, 它会把信息提供给后端进行处理;
5. **建图** (Mapping). 它根据估计的轨迹, 建立与任务要求对应的地图;

经典的视觉 SLAM 框架是过去十几年的研究成果. 这个框架本身及其所包含的算法已经基本定型, 并且已经在许多视觉程序库和机器人程序库中提供. 依靠这些算法, 我们能够构建一个视觉 SLAM 系统, 使之在正常的工作环境里实时定位与建图. 因此, 我们说, **如果把工作环境限定在静态、刚体、光照变化不明显、没有人为干扰的场景**, 那么这个 SLAM 系统是相当成熟的了.

### 2.1.1 视觉里程计

视觉里程计关心的是**相邻图像**之间的相机运动, 为了能通过图像数据定量地估计相机运动, 必须先了解相机与空间点的几何关系. VO 能够通过相邻帧间的图像估计相机运动, 并恢复场景的空间结构. 称它为"里程计"是因为它和实际的里程计一样, 只计算相邻时刻的运动, 而**和再往前的过去信息没有关联**. 在这一点上, VO 就像一种**只有短时间记忆**的物种.

现在, 假定我们已有了一个视觉里程计, 估计了两张图像间的相机运动. 那么只要把相邻时刻的运动"串起来", 即构成了机器人的运动轨迹, 从而解决了定位问题. 另一方面, 我们根据每个时刻的相机位置, 计算出各像素对应的空间点的位置, 就得到了地图. 然而, 仅通过视觉里程计来估计轨迹, 将不可避免地出现累积**漂移** (Accumulating Drift).

为了解决漂移问题, 我们还需要两种技术: 后端优化和回环检测. 回环检测负责把"**机器人回到原始位置**"的事情检测出来, 而后端优化则根据该信息, 校正整个轨迹的形状.

### 2.1.2 后端优化

笼统地说, 后端优化主要指处理 SLAM 过程中噪声的问题. 除了解决"如何从图像估计出相机运动"之外, 我们还要关心这个估计带有多大的噪声, 这些噪声是如何从上一时刻传递到下一时刻的, 而我们又对当前的估计有多大的自信. **后端优化要考虑的问题, 就是如何从这些带有噪声的数据中估计整个系统的状态, 以及这个状态估计的不确定性有多大**——这称为最大后验概率估计 (Maximum-a-Posteriori, MAP).

在视觉 SLAM 中, 前端和计算机视觉研究领域更为相关, 比如**图像的特征点提取与匹配等**, 后端则主要是**滤波与非线性优化算法**.

从历史意义上来说, 现在我们称为后端优化的部分, 很长一段时间直接被称为"SLAM 研究". 早期的 SLAM 问题是一个状态估计问题——正是后端优化要解决的东西. 在最早提出 SLAM 的一系列论文中, 当时的人们称它为"空间状态不确定性的估计" (Spatial Uncertainty). 虽然有一些晦涩, 但也确实反映出了 SLAM 问题的本质: **对运动主体自身和周围环境空间不确定性的估计**. 为了解决 SLAM 问题, 我们需要状态估计理论, 把定位和建图的不确定性表达出来, 然后**采用滤波器或非线性优化, 估计状态的均值和不确定性 (方差)**. 

### 2.1.3 回环检测

如果有某种手段, 让机器人知道"回到了原点"这件事, 或者把"原点"识别出来, 我们再把位置估计值"拉"过去, 就可以消除漂移了. 这就是所谓的回环检测. 为了实现回环检测, 我们需要让机器人具有识别到过的场景的能力. 可以通过判断图像间的相似性来完成回环检测. 这一点和人是相似的. 当我们看到两张相似的图片时, 容易辨认它们来自同一个地方. 如果回环检测成功, 可以显著地减小累计误差. **所以视觉回环检测实质上是一种计算图像数据相似性地算法**. 由于图像的信息非常丰富, 使得正确检测回环的难度降低了不少.

### 2.1.4 建图

对于地图, 有太多需求和针对性的解决方法, 因此, 相比于前面提到的视觉里程计、回环检测和后端优化, 建图并没有一个固定的形式和算法. 一组空间点的集合可以称为地图, 一个漂亮的 3D 模型亦是地图, 一个标记着城市、村庄、铁路、河道的图片还是地图. 地图的形式随 SLAM 的应用场合而定. **大体上讲, 可以分为度量地图与拓扑地图两种.**

- **度量地图** (Metric Map)
  度量地图**强调精确地表示地图中物体的位置关系**, 通常用稀疏 (Sparse) 与稠密 (Dense) 对其分类. 稀疏地图进行了一定程度的抽象, 并不需要表达所有的物体. 例如, 我们选择一部分有代表意义的东西称之为路标 (Landmark), 那么一张稀疏地图就是由路标组成的地图, 而不是路标的部分就可以忽略掉. 相对地, 稠密地图着重于建模所有看到的东西. 对于定位来说, 稀疏路标地图就足够了. 而用于导航时, 则往往需要稠密的地图 (否则撞上两个路标之间的墙怎么办?) 稠密地图通常按照某种分辨率, 由许多个小块组成. 对于二维度量地图是许多个小格子 (Grid), 而对于三维度量地图则是许多小方块 (Voxel).
- **拓扑地图** (Topological Map)
  相比于度量地图的精确性, 拓扑地图则更强调地图元素之间的关系. 拓扑地图是一个图 (Graph), 由节点和边组成, **只考虑节点间的连通性**, 例如 A、B 点是连通的, 而不考虑如何从 A 点到达 B 点. 它放松了地图对精确位置的需要, 去掉了地图的细节问题, 是一种更为紧凑的表达方式. 然而, 拓扑地图不擅长表达具有复杂结构的地图. 如何对地图进行分割形成结点与边, 又如何使用拓扑地图进行导航与路径规划, 仍是有待研究的问题.

## 2.2 SLAM问题的数学表述

